<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <?!= include('style.css'); ?>
</head>

<body>
    <div id="loading-spinner" style="display: none;">
        <div class="spinner-overlay"></div>
        <div class="spinner-container">
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
        </div>
    </div>

    <div id="login-container">

        <div class="card shadow-sm" style="width: 22rem;">
            <div class="text-center"><img src="https://storage.googleapis.com/vitor-krewer/projects/images/logo-learning-fly-full.png"
                    alt="Logo da Empresa" style="max-width: 200px; margin-bottom: 1.5rem;"></div>
            <div class="card-body p-4">
                <h5 class="card-title text-center mb-4">Acesso ao Painel</h5>
                <div class="mb-3">
                    <label for="username" class="form-label">Usuário</label>
                    <input type="text" class="form-control" id="username" placeholder="Insira o seu usuário">
                </div>
                <div class="mb-3">
                    <label for="clientKey" class="form-label">Chave de Acesso</label>
                    <input type="password" class="form-control" id="clientKey" placeholder="Insira a sua chave">
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary" onclick="handleLogin()">Entrar</button>
                </div>
                <div id="login-error" class="text-danger text-center mt-3" style="display: none;">Usuário ou chave
                    inválida.</div>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="container-fluid mt-4" style="display: none;">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h4 class="mb-0 me-3"><i class="bi bi-clipboard-data-fill"></i> Painel de Solicitações</h4>
                    <span class="text-muted fst-italic me-2" style="font-size: 0.8rem;">by</span>
                    <img src="https://storage.googleapis.com/vitor-krewer/projects/images/logo-learning-fly-full.png" alt="LearningFly"
                        style="height: 25px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#aboutModal">
                </div>
                <div class="d-flex align-items-center">
                    <input type="text" id="searchInput" class="form-control form-control-sm me-2"
                        placeholder="Procurar por nome, CPF...">
                    <button class="btn btn-light btn-sm" onclick="fetchData()"><i class="bi bi-arrow-clockwise"></i>
                        Atualizar</button>
                </div>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="statusTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-status="Todos" type="button">
                          <i class="bi bi-card-list"></i> Solicitações</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-status="Dados" type="button">
                          <i class="bi bi-table"></i> Dados</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-status="Indicadores" type="button">
                          <i class="bi bi-bar-chart-line-fill"></i> Indicadores</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-status="Histórico Acadêmico" type="button">
                          <i class="bi bi-mortarboard-fill"></i> Histórico Acadêmico</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-status="Declaracoes" type="button">
                            <i class="bi bi-file-earmark-text-fill"></i> Declarações
                        </button>
                    </li>
                </ul>

                <div id="solicitacoes-view">
                    <ul class="nav nav-pills mb-3" id="solicitacoesStatusTabs">
                        <li class="nav-item"><button class="nav-link active" data-status="Todos"
                                type="button">Todos</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="Recebido"
                                type="button">Recebidos</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="Em Análise" type="button">Em
                                Análise</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="Concluído"
                                type="button">Concluídos</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="Indeferido"
                                type="button">Indeferidos</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="Cancelado"
                                type="button">Cancelados</button></li>
                    </ul>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-dark" style="position: sticky; top: 0;">
                                <tr>
                                    <th>Protocolo</th>
                                    <th>Data</th>
                                    <th>Nome</th>
                                    <th>Instituição</th>
                                    <th>Curso</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="requests-table-body"></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" class="d-flex justify-content-between align-items-center mt-3">
                        <div class="d-flex align-items-center">
                            <label for="rows-per-page" class="form-label me-2 mb-0">Linhas:</label>
                            <select id="rows-per-page" class="form-select form-select-sm" style="width: auto;">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0"></ul>
                        </nav>
                    </div>
                </div>

                <div id="indicators-content" class="p-2" style="display: none;">
                    <h4>Métricas e Indicadores</h4>
                    <div id="average-indicators-cards" class="row"></div>
                    <h4 class="mt-4">Solicitações por Dia (Últimos 15 dias)</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead id="last-15-days-thead" class="table-dark"></thead>
                            <tbody id="last-15-days-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="data-view-content" style="display: none;">
                    <div id="data-view-controls" class="mb-2">
                        <button id="copy-selected-btn" class="btn btn-primary btn-sm" style="display: none;"
                            onclick="openColumnSelectModal()">
                            <i class="bi bi-clipboard-check"></i> Copiar Selecionados
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-sm">
                            <thead id="data-table-head" class="table-dark" style="position: sticky; top: 0;"></thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="historico-view" style="display: none;">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="instituicao-select" class="form-label fw-bold">1. Selecione a
                                Instituição</label>
                            <select id="instituicao-select" class="form-select"></select>
                        </div>
                        <div class="col-md-8">
                            <label for="curso-search-input" class="form-label fw-bold">2. Busque e selecione o
                                Curso</label>
                            <input class="form-control" list="cursos-datalist" id="curso-search-input"
                                placeholder="Digite para buscar..." disabled>
                            <datalist id="cursos-datalist"></datalist>
                        </div>
                    </div>
                    <hr>
                    <div id="historico-main-content" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Detalhes do Curso</h5>
                            <button id="export-template-btn" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-file-earmark-arrow-down-fill"></i> Exportar Template do Curso
                            </button>
                        </div>
                        <div id="curso-details-display" class="card card-body bg-light mb-4"></div>

                        <h5>Grade Curricular (Histórico Padrão)</h5>
                        <div id="historico-table-container" class="table-responsive mb-4"></div>

                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mt-4">3. Alunos com Status "Concluído"</h5>
                            <button id="find-alunos-btn" class="btn btn-primary">
                                <i class="bi bi-search"></i> Buscar Alunos para o Curso Selecionado
                            </button>
                        </div>

                        <div id="aluno-selection-container" class="card mt-3 mb-4" style="display: none;">
                            <div id="aluno-list" class="list-group list-group-flush"
                                style="max-height: 300px; overflow-y: auto;">
                            </div>
                        </div>

                        <button id="export-historico-btn" class="btn btn-success btn-lg" disabled>
                            <i class="bi bi-file-earmark-spreadsheet-fill"></i> Exportar Histórico para Alunos
                            Selecionados
                        </button>
                    </div>
                </div>
                <div id="declarations-content" class="p-2" style="display: none;">
                    <div class="accordion mb-4" id="accordion-nova-declaracao">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse-nova-declaracao" aria-expanded="false"
                                    aria-controls="collapse-nova-declaracao">
                                    <i class="bi bi-plus-circle-fill me-2"></i> Inserir Nova Declaração
                                </button>
                            </h2>
                            <div id="collapse-nova-declaracao" class="accordion-collapse collapse"
                                aria-labelledby="headingOne" data-bs-parent="#accordion-nova-declaracao">
                                <div class="accordion-body bg-light">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="inserir-declaracao-instituicao-select"
                                                class="form-label">Instituição</label>
                                            <select id="inserir-declaracao-instituicao-select"
                                                class="form-select"></select>
                                        </div>
                                        <div class="col-md-5">
                                            <label for="cpf-declaracao" class="form-label">CPF do Aluno</label>
                                            <input type="text" id="cpf-declaracao" class="form-control"
                                                placeholder="Digite o CPF (apenas números)">
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button id="buscar-dados-declaracao-btn" class="btn btn-primary w-100">
                                                <i class="bi bi-search"></i> Buscar Dados
                                            </button>
                                        </div>
                                    </div>
                                    <div id="dados-aluno-container" class="mt-4" style="display: none;">
                                        <div class="card">
                                            <div class="card-header fw-bold">Dados do Aluno Encontrado</div>
                                            <div class="card-body">
                                                <p><strong>Nome:</strong> <span id="nome-declaracao"></span></p>
                                                <p><strong>CPF:</strong> <span id="cpf-exibido-declaracao"></span></p>
                                                <p><strong>Email:</strong> <span id="email-declaracao"></span></p>
                                            </div>
                                        </div>
                                        <div class="card mt-3">
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label for="cursos-declaracao" class="form-label">Selecione o
                                                            Curso</label>
                                                        <select id="cursos-declaracao" class="form-select"></select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="tipo-declaracao-select" class="form-label">Tipo de
                                                            Declaração</label>
                                                        <select id="tipo-declaracao-select" class="form-select">
                                                            <option value="declaracoes.matricula">Matrícula</option>
                                                            <option value="declaracoes.conclusao">Conclusão</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <button id="preencher-declaracao-btn" class="btn btn-success mt-3">
                                                    <i class="bi bi-check-circle-fill"></i> Inserir na Planilha
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5><i class="bi bi-list-task"></i> Declarações Inseridas</h5>
                            <small class="text-muted">Visualize, gere PDFs e envie as declarações por e-mail.</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <select id="view-declaracao-instituicao-select" class="form-select me-2"
                                style="width: auto;">
                                <option value="" selected disabled>Selecione uma instituição...</option>
                            </select>
                            <button id="refresh-declarations-btn" class="btn btn-light">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <ul class="nav nav-pills mb-3" id="declarations-type-tabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-type="declaracoes.matricula" type="button"><i
                                    class="bi bi-person-badge"></i> Matrícula</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-type="declaracoes.conclusao" type="button"><i
                                    class="bi bi-patch-check-fill"></i> Conclusão</button>
                        </li>
                    </ul>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered table-sm">
                            <thead id="declarations-table-head" class="table-dark" style="position: sticky; top: 0;">
                            </thead>
                            <tbody id="declarations-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Solicitação</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsModalBody"></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Fechar</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="column-select-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Selecionar Colunas para Copiar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="column-select-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="copySelectedData()">Confirmar Cópia</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel"><i class="bi bi-info-circle-fill"></i> Sobre</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center"><img src="https://storage.googleapis.com/vitor-krewer/projects/images/logo-learning-fly-full.png"
                            alt="Logo da Empresa" style="max-width: 200px; margin-bottom: 1.5rem;"></div>
                    <p><strong>Do insight à solução: o caminho até o LearningFly</strong></p>
                    <p><strong>LearningFly</strong> é mais do que uma ferramenta — é um copiloto educacional. Criado
                        para tornar a gestão de cursos mais simples, inteligente e organizada, ele permite localizar,
                        cadastrar e acompanhar informações sobre repositórios de materiais didáticos, recursos de
                        aprendizagem, cursos e processos pedagógicos e de secretaria. Tudo em um único lugar com fluidez
                        e precisão. Também conta com recursos modulares.</p>
                    <p>O projeto nasceu da pergunta: <em>“E se a tecnologia realmente trabalhasse a favor de quem
                            coordena e educa?”</em> A resposta foi um sistema leve, automatizado e conectado diretamente
                        ao ecossistema Google, usando <strong>Google Apps Script</strong> como motor e
                        <strong>Inteligência Artificial</strong> como aliada estratégica.
                    </p>
                    <p>Do primeiro rascunho à aplicação funcional, tudo foi idealizado, estruturado e desenvolvido por
                        <strong>Vitor Krewer</strong> — unindo código, design e visão sistêmica. O resultado é uma
                        solução que prova como ferramentas acessíveis podem gerar alto impacto quando há propósito,
                        intenção e pensamento técnico por trás.
                    </p>
                    <hr>
                    <p class="text-center">
                        Conecte-se com o desenvolvedor: <br>
                        <a href="https://www.linkedin.com/in/vitorkrewer/" target="_blank" class="linkedin-link"
                            rel="noopener noreferrer">
                            <i class="bi bi-linkedin"></i> Vitor Krewer no LinkedIn
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>


    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header"><strong class="me-auto" id="toast-title"></strong><button type="button"
                    class="btn-close" data-bs-dismiss="toast"></button></div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <?!= include('application.js'); ?>
    <?!= include('events.js'); ?>
    <?!= include('modals.js'); ?>
    <?!= include('services.js'); ?>
    <?!= include('ui.js'); ?>
    </script>
</body>

</html>